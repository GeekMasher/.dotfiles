#!/bin/bash
# Interactive git commit helper with conventional commits support

set -e

if ! command -v gum &> /dev/null; then
    echo "[!] Gum is not installed, please install the tool"
    echo " > https://github.com/charmbracelet/gum"
    exit 1
fi

if ! git rev-parse --is-inside-work-tree &> /dev/null; then
    echo "[!] Not in a git repository"
    exit 1
fi

TYPE=$(gum choose "feat" "fix" "docs" "style" "refactor" "perf" "test" "build" "ci" "chore" "revert")
SCOPE=$(gum input --placeholder "scope (optional)")

test -n "$SCOPE" && SCOPE="($SCOPE)"

SUMMARY=$(gum input --value "$TYPE$SCOPE: " --placeholder "Summary of this change" --width=90 --char-limit=72)
DESCRIPTION=$(gum write --placeholder "Details of this change (CTRL+D to finish)")

if [ -z "$SUMMARY" ]; then
    echo "[!] Commit summary cannot be empty"
    exit 1
fi

STAGED_FILES=$(git diff --cached --name-only)
if [ -z "$STAGED_FILES" ]; then
    echo "[!] No staged files found"
    UNSTAGED_FILES=$(git status -s -uno | grep -v '^??' | wc -l)
    if [ "$UNSTAGED_FILES" -gt 0 ]; then
        gum confirm "Stage all modified files?" && git add -u || exit 1
    else
        echo "[!] No files to commit"
        exit 1
    fi
fi

gum style --foreground 214 "Files to commit:"
git diff --cached --name-status | gum format

gum confirm "Commit changes?" && git commit -m "$SUMMARY" -m "$DESCRIPTION"

if git remote | grep -q origin; then
    CURRENT_BRANCH=$(git branch --show-current)
    GIT_URL=$(git config --get remote.origin.url)
    if gum confirm "Push to remote? ${GIT_URL} (${CURRENT_BRANCH})"; then
        gum spin --spinner dot --title "Pushing to ${CURRENT_BRANCH}..." -- git push origin "$CURRENT_BRANCH"
    fi
else
    echo "[!] No remote 'origin' configured, skipping push"
fi

gum style \
    --border double \
    --border-foreground="#8ac149" --foreground="#8ac149" \
    --align center --width 50 --margin "1 2" --padding "2 4" \
    'Commit successful! âœ“'
